import { Post } from '../HttpResponse'
import { PostPracticeRunParams, PostPracticeRunResults } from '../protocol/PostPracticeRun'
import { codeSubmissionService } from '../service/codeSubmission'
import { judgeService } from '../service/judge'
import { storageService } from '../service/storage'

export const postPracticeRunController = Post<PostPracticeRunParams, PostPracticeRunResults>(
  async ({ code, problemId, codeType, category, participantId }) => {
    codeSubmissionService.logPracticeSubmission(category, problemId, participantId, code)

    const inFiles = await storageService.getFiles(`${category}/${problemId}/in/`)
    const outFiles = await storageService.getFiles(`${category}/${problemId}/out/`)

    const results = await Promise.all(
      inFiles.slice(0, 5).map(async (input, i) => {
        const key = `p${participantId}-${problemId}-${i}`
        return await judgeService.test(key, input.content, outFiles[i].content, code, codeType)
      })
    )

    const score = results.reduce((prev, cur) => (cur[0] ? prev + 1 : prev), 0)

    return {
      correctCases: score,
      testcases: results.length,
      output: results.map(r => {
        return {
          input: r[3],
          output: r[1],
          expected: r[2],
          correct: r[0],
        }
      }),
    }
  }
)
